# 破坏活动目录

在此网络中，我们将介绍几种可用于破坏AD 的方法。这绝不是一个完整的列表，因为每天都会发现新的方法和技术。

NTLM 认证服务
LDAP 绑定凭证
认证中继
微软部署工具包
配置文件



如何连接到网络

如果是用attackbox攻击箱

1.下载thm的openvpn配置文件，并上传到attackbox

2.修改ovpn配置文件，将"dev breachad" 替换成"dev tun"

3.输入命令systemd-resolve --interface breachad --set-dns $THMDCIP --set-domain za.tryhackme.com 

  #这里的$THMDCIP替换成THMDC的ip，然后"breachad"这里是指定一块网卡,刚刚连接了openvpn后应该生成一块名为tun0的网卡，所以这里将"breachad"替换成"tun0"





## NTLM认证服务

New Technology LAN Manager （NTLM）是一套安全协议，用于在AD中验证用户身份。通过使用称为 NetNTLM 的基于质询-响应的方案，NTLM 可用于身份验证。这种身份验证机制被网络上的服务大量使用。但是，使用 NetNTLM 的服务也可以暴露在互联网上。以下是一些流行的示例：

公开 Outlook Web App (OWA) 登录门户的内部托管 Exchange (Mail) 服务器。
暴露于 Internet 的服务器的远程桌面协议 ( RDP ) 服务。
与AD集成的暴露的 VPN 端点。
面向 Internet 并使用 NetNTLM 的 Web 应用程序。



NetNTLM，通常也称为 Windows 身份验证或简称为 NTLM 身份验证，允许应用程序在客户端和AD之间扮演中间人的角色。所有身份验证材料都以质询的形式转发给域控制器，如果成功完成，应用程序将对用户进行身份验证。



## LDAP

应用程序可以使用的另一种AD身份验证方法是轻量级目录访问协议 (LDAP) 身份验证。LDAP 身份验证类似于 NTLM 身份验证。但是，使用 LDAP 身份验证时，应用程序会直接验证用户的凭据。该应用程序有一对 AD 凭据，它可以首先使用它们来查询 LDAP，然后验证 AD 用户的凭据。

LDAP 身份验证是与AD集成的第三方（非 Microsoft）应用程序的流行机制。这些包括应用程序和系统，例如：

GitLab
詹金斯
定制开发的网络应用程序
打印机
VPN

LDAP 回传攻击

但是，可以针对 LDAP 身份验证机制执行另一种非常有趣的攻击，称为 LDAP 回传攻击。这是对网络设备（例如打印机）的常见攻击，当您获得对内部网络的初始访问权限时，例如在会议室中插入流氓设备。

当我们获得对指定 LDAP 参数的设备配置的访问权限时，可以执行 LDAP 回传攻击。例如，这可以是网络打印机的 Web 界面。通常，这些接口的凭据保留为默认凭据，例如admin:admin或admin:password。在这里，我们将无法直接提取 LDAP 凭据，因为密码通常是隐藏的。但是，我们可以更改 LDAP 配置，例如 LDAP 服务器的 IP 或主机名。在 LDAP 回传攻击中，我们可以将此 IP 修改为我们的 IP，然后测试 LDAP 配置，这将强制设备尝试对我们的恶意设备进行 LDAP 身份验证。我们可以拦截此身份验证尝试以恢复 LDAP 凭据。



### 托管流氓 LDAP 服务器





## 认证中继

SMB协议在ad网络中的运行流程

LLMNR、NBT-NS 和 WPAD

拦截 NetNTLM 挑战

```
sudo responder -I tun0


```



## 微软部署工具包

MDT和SCCM



## 配置文件

我们将在此网络中探索的最后一个枚举途径是配置文件。假设您很幸运地造成了一次破坏，使您可以访问组织网络上的主机。在这种情况下，配置文件是尝试恢复AD凭据的绝佳途径。根据被破坏的主机，各种配置文件可能具有枚举价值： 

Web 应用程序配置文件
服务配置文件
注册表项
集中部署的应用程序

可以使用多个枚举脚本（例如Seatbelt[译为安全带] ）来自动执行此过程。



配置文件凭据

