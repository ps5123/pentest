# 杀毒软件简介

防病毒 ( AV ) 软件是基于主机的基本安全解决方案之一，可用于检测和防止最终用户机器内的恶意软件攻击。 AV软件由不同的模块、功能和检测技术组成，将在本会议室进行讨论。

作为一名红队成员或渗透测试人员，熟悉并了解反病毒软件 及其检测技术的 工作原理至关重要。一旦掌握了这些知识，就可以更容易地使用AV规避技术。

# 防毒软件

### 反病毒软件寻找什么？

传统的AV软件会查找 具有预定义恶意模式或签名的恶意软件 。恶意软件是一种有害软件，其主要目标是对目标机器造成损害，包括但不限于：

获得对目标机器的完全访问权限。
窃取密码等敏感信息。
加密文件并导致文件损坏。
注入其他恶意软件或不需要的广告。
使用受感染的机器执行进一步的攻击，例如僵尸网络攻击



### AV与其他安全产品



除了AV软件，其他基于主机的安全解决方案也为端点设备提供实时保护。端点检测和响应 (EDR) 是一种安全解决方案，可根据行为分析提供实时保护。防病毒应用程序执行扫描、检测和删除恶意文件。另一方面，EDR 监控目标机器中的各种安全检查，包括文件活动、内存、网络连接、Windows 注册表、进程等。

现代防病毒产品的实施是将传统的防病毒功能和其他高级功能（类似于EDR功能）集成到一个产品中，以提供针对数字威胁的全面保护。 有关基于主机的安全解决方案的更多信息，我们建议访问 THM 室：  The Lay of the Land 。

过去和现在的AV软件

McAfee Associates, Inc. 于 1987 年开始实施第一个AV软件。它被称为“VirusScan”，当时的主要目标是删除感染 John McAfee 计算机的名为“Brain”的病毒。 后来，其他公司也加入了与病毒的战斗。AV软件被称为扫描仪，它们是在文件中搜索恶意模式的命令行软件。

从那以后，情况发生了变化。现在的AV软件使用图形用户界面 (GUI) 来执行恶意文件扫描和其他任务。恶意软件程序的范围也有所扩大，现在以 Windows 和其他操作系统上的受害者为目标。 现代AV软件支持大多数设备和平台，包括 Windows、Linux、macOS、Android 和 iOS。现代AV软件已经改进并变得 更加智能和复杂，因为它们包含了一系列通用功能，包括防病毒、反漏洞利用、防火墙、加密工具等。

我们将在下一个任务中讨论一些AV功能。



## 防病毒功能

### 杀毒引擎

AV引擎负责查找和删除恶意代码和文件。好的 AV 软件实现了一个有效和可靠的 AV 核心，可以准确快速地分析 恶意文件。此外，它应该处理和支持各种文件类型，包括存档文件，它可以在其中自解压和检查所有压缩文件。

大多数AV产品具有相同的通用功能，但实现方式不同，包括但不限于：

扫描器
检测技术
压缩机和档案
拆包机
模拟器



扫描器

大多数AV产品都包含扫描仪功能：AV 软件实时或按需运行和扫描。此功能可在 GUI 中或通过命令提示符使用。用户可以在需要检查文件或目录时随时使用它。扫描功能必须支持最知名的恶意文件类型才能检测并消除威胁。此外，它还可能支持其他类型的扫描，具体取决于 AV 软件，包括漏洞、电子邮件、Windows 内存和 Windows 注册表。

检测技术

AV检测技术搜索和检测恶意文件；可以在 AV 引擎中使用不同的检测技术，包括：

基于签名的检测是传统的AV技术，可在文件中查找预定义的恶意模式和签名。
启发式检测是一种更高级的技术，包括用于分析可疑文件的各种行为方法。
动态检测是一种包括监视系统调用和 API 以及在隔离环境中进行测试和分析的技术。
我们将在下一个任务中介绍这些技术。一个好的AV引擎是准确的，可以快速检测恶意文件，误报结果更少。我们将展示几种提供不准确结果和错误分类文件的 AV 产品。

压缩机和档案

任何AV软件都应包含“压缩器和存档”功能。它必须支持并能够处理各种系统文件类型，包括压缩文件或存档文件：ZIP、TGZ、7z、XAR、RAR 等。恶意代码通常试图通过隐藏在压缩文件中来逃避基于主机的安全解决方案。 出于这个原因，AV软件必须在用户打开存档中的文件之前解压缩并扫描所有文件。

PE  （可移植可执行文件）解析和解 包器

恶意软件通过在有效负载中压缩和加密恶意代码来隐藏和打包其恶意代码。它会在运行时自行解压缩和解密，使执行静态分析变得更加困难。因此，AV软件必须能够在运行时之前检测和解压大多数已知的加壳程序（UPX、Armadillo、ASPack 等）以进行静态分析。

恶意软件开发人员使用各种技术（例如加壳）来缩小恶意文件的大小并更改其结构。打包压缩原始可执行文件，使其更难分析。因此，反病毒软件必须具有解包功能，可以将受保护或压缩的可执行文件解包为原始代码。

AV软件必须具备的另一个功能是 Windows 可移植可执行 (PE) 标头解析器。解析可执行文件的PE有助于区分恶意软件和合法软件（.exe文件）。Windows 中的 PE 文件格式（32 位和 64 位）包含各种信息和资源，例如目标代码、DLL、图标文件、字体文件和核心转储。

模拟器

模拟器是一种防病毒功能，可对可疑文件进行进一步分析。一旦模拟器收到请求，模拟器就会在虚拟化和受控环境中运行可疑（exe、DLL、PDF 等）文件。它在执行期间监视可执行文件的行为，包括 Windows API 调用、注册表和其他 Windows 文件。以下是模拟器可能收集的工件示例：

API调用
内存转储
文件系统修改
记录事件
运行进程
网络请求
当收集到足够多的工件以检测恶意软件时，模拟器会停止执行文件。

其他共同特点

以下是AV产品中的一些常见功能：

一种自我保护驱动程序，以防止恶意软件攻击实际的AV。
防火墙和网络检查功能。
命令行和图形界面工具。
守护进程或服务。
管理控制台。