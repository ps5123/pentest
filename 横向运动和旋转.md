# 横向运动和旋转

## 通过网络移动

什么是横向运动？
简而言之，横向移动是攻击者用来在网络中移动的一组技术。一旦攻击者获得了对网络第一台机器的访问权限，出于多种原因，移动是必不可少的，其中包括： - 实现我们作为攻击者的目标 - 绕过现有的网络限制 - 建立额外的网络入口点 - 制造混乱和避免被发现。

虽然许多网络杀伤链将横向移动视为线性过程的附加步骤，但它实际上是一个循环的一部分。在此周期中，我们使用任何可用的凭据执行横向移动，使我们能够访问新机器，并在可能的情况下提升权限并提取凭据。使用新发现的凭据，循环再次开始。

通常，在网络上达到我们的最终目标之前，我们会重复这个循环几次。如果我们的第一个立足点是一台访问其他网络资源的机器很少，我们可能需要横向移动到其他在网络上拥有更多权限的主机。

### 攻击者的视角

攻击者可以通过多种方式横向移动。最简单的方法是使用 标准管理协议，如 WinRM、RDP、VNC 或 SSH 连接到网络上的其他机器。这种方法可用于在某种程度上模拟普通用户的行为，只要在计划在何处与什么帐户连接时保持某种连贯性即可。虽然来自 IT 的用户通过 RDP 连接到 Web 服务器可能很常见并且不被注意，但必须注意不要尝试可疑连接 （例如，为什么本地管理员用户从营销-连接到 DEV-001-PC电脑？）。

现在的攻击者还有其他横向移动的方法，同时让蓝队更难 有效地检测正在发生的事情。虽然没有任何技术应该被认为是万无一失的，但我们至少可以尝试尽可能保持沉默。在以下任务中，我们将研究一些最常见的横向移动技术。



### 管理员和UAC

在执行整个房间介绍的大部分横向移动技术时，我们将主要使用管理员凭据。虽然人们可能期望每个管理员帐户都具有相同的目的，但必须区分两种类型的管理员：

本地管理员组的本地帐户部分
本地管理员组的域帐户部分
我们感兴趣的差异是用户帐户控制 ( UAC )对本地管理员（默认管理员帐户除外）施加的限制。默认情况下，本地管理员将无法远程连接到机器并执行管理任务，除非通过RDP使用交互式会话。Windows 将拒绝通过 RPC、SMB 或 WinRM 请求的任何管理任务，因为此类管理员将使用经过过滤的中等完整性令牌登录，从而阻止帐户执行特权操作。唯一可以获得全部权限的本地帐户是默认管理员帐户。

具有本地管理权限的域帐户将不会受到相同的处理，并且将以完全管理权限登录。

如果需要，可以禁用此安全功能，有时您会发现管理员组中的本地帐户和域帐户没有区别。不过，必须记住，如果某些横向移动技术失败，可能是由于使用了强制执行UAC的非默认本地管理员。您可以 在此处阅读有关此安全功能的更多详细信息。



## 远程产卵过程

Psexec（执行器）

端口： 445/TCP (SMB)
所需的组成员身份：管理员
多年来，当需要远程执行进程时，Psexec 一直是首选方法。它允许管理员用户在他有权访问的任何 PC 上远程运行命令。Psexec 是众多 Sysinternals 工具之一，可在此处下载。

psexec 的工作方式如下：

连接到 Admin$ 共享并上传服务二进制文件。Psexec 使用 psexesvc.exe 作为名称。
连接到服务控制管理器以创建和运行名为 PSEXESVC 的服务，并将服务二进制文件与C:\Windows\psexesvc.exe.
创建一些命名管道来处理 stdin/stdout/stderr。

要运行 psexec，我们只需要为远程主机提供所需的管理员凭据和我们要运行的命令（为方便起见，在 THMJMP2 中psexec64.exe可用）：C:\tools

```
psexec64.exe \\MACHINE_IP -u Administrator -p Mypass123 -i cmd.exe
```

### 使用 WinRM 创建远程进程

端口：5985/TCP (WinRM HTTP ) 或 5986/TCP (WinRM HTTPS)
所需的组成员身份：远程管理用户
Windows 远程管理 (WinRM) 是一种基于 Web 的协议，用于将 Powershell 命令远程发送到 Windows 主机。大多数 Windows Server 安装都会默认启用 WinRM，这使其成为一个有吸引力的攻击媒介。

要从命令行连接到远程 Powershell 会话，我们可以使用以下命令：

```
winrs.exe -u:Administrator -p:Mypass123 -r:target cmd
```

我们可以从 Powershell 实现相同的目的，但要传递不同的凭据，我们需要创建一个 PSCredential 对象：

```
$username = 'Administrator';
$password = 'Mypass123';
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force; 
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword;
```

一旦我们有了 PSCredential 对象，我们就可以使用 Enter-PSSession cmdlet 创建一个交互式会话：

```
Enter-PSSession -Computername TARGET -Credential $credential
```

Powershell 还包括 Invoke-Command cmdlet，它通过 WinRM 远程运行 ScriptBlocks。凭据也必须通过 PSCredential 对象传递：

```
Invoke-Command -Computername TARGET -Credential $credential -ScriptBlock {whoami}
```

### 使用 sc远程 创建服务

端口：
135/TCP, 49152-65535/TCP (DCE/RPC)
445/TCP（SMB 命名管道上的 RPC）
139/TCP（SMB 命名管道上的 RPC）
所需的组成员身份：管理员
Windows 服务也可用于运行任意命令，因为它们在启动时执行命令。虽然服务可执行文件在技术上不同于常规应用程序，但如果我们将 Windows 服务配置为运行任何应用程序，它仍会执行它并在之后失败。

我们可以使用 sc.exe 在远程主机上创建服务，sc.exe 是 Windows 中可用的标准工具。在使用 sc 时，它会尝试通过以下几种方式通过 RPC 连接到服务控制管理器 (SVCCTL) 远程服务程序：

1.将使用 DCE/RPC 进行连接尝试。客户端首先会在端口 135 连接到 Endpoint Mapper (EPM)，它充当可用 RPC 端点的目录并请求有关 SVCCTL 服务程序的信息。然后 EPM 将使用 IP 和端口响应以连接到 SVCCTL，该端口通常是 49152-65535 范围内的动态端口。

2.如果后一个连接失败，sc 将尝试通过 SMB 命名管道到达 SVCCTL，端口 445 (SMB) 或 139（SMB over NetBIOS）。

我们可以使用以下命令创建并启动名为“THMservice”的服务：

```
sc.exe \\TARGET create THMservice binPath= "net user munra Pass123 /add" start= auto
sc.exe \\TARGET start THMservice
```

“net user”命令将在服务启动时执行，在系统上创建一个新的本地用户。由于操作系统负责启动服务，您将无法查看命令输出。

要停止和删除该服务，我们可以执行以下命令：

```
sc.exe \\TARGET stop THMservice
sc.exe \\TARGET delete THMservice
```

### 远程创建计划任务

我们可以使用的另一个 Windows 功能是计划任务。您可以使用 schtasks 远程创建和运行一个，在任何 Windows 安装中都可用。要创建名为 THMtask1 的任务，我们可以使用以下命令：

```
schtasks /s TARGET /RU "SYSTEM" /create /tn "THMtask1" /tr "<command/payload to execute>" /sc ONCE /sd 01/01/1970 /st 00:00 

schtasks /s TARGET /run /TN "THMtask1" 
```

我们将计划类型 (/sc) 设置为 ONCE，这意味着该任务仅在指定的时间和日期运行一次。由于我们将手动运行任务，因此开始日期 (/sd) 和开始时间 (/st) 无论如何都无关紧要。

由于系统将运行计划任务，命令的输出将对我们不可用，这使这是一种盲目攻击。

最后，要删除计划任务，我们可以使用以下命令并自行清理：

```
schtasks /S TARGET /TN "THMtask1" /DELETE /F
```



## 使用WMI横向移动

WMI 是基于 Web 的企业管理 (WBEM) 的 Windows 实现，WBEM 是跨设备访问管理信息的企业标准。 

简单来说，WMI允许管理员执行标准的管理任务，攻击者可以滥用这些任务以各种方式执行横向移动，我们将对此进行讨论。

### 从 Powershell连接到WMI

在能够使用 Powershell 命令连接到WMI之前，我们需要使用我们的用户和密码创建一个 PSCredential 对象。该对象将存储在 $credential 变量中，并在该任务的整个技术中使用：

```
$username = 'Administrator';
$password = 'Mypass123';
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword;
```

### 使用WMI创建远程进程

### 使用WMI远程创建服务

### 使用WMI远程创建计划任务

### 通过WMI安装 MSI 包

```
PS C:\> $username = 't1_corine.waters';
PS C:\> $password = 'Korine.1994';
PS C:\> $securePassword = ConvertTo-SecureString $password -AsPlainText -Force;
PS C:\> $credential = New-Object System.Management.Automation.PSCredential $username, $securePassword;
PS C:\> $Opt = New-CimSessionOption -Protocol DCOM
PS C:\> $Session = New-Cimsession -ComputerName thmiis.za.tryhackme.com -Credential $credential -SessionOption $Opt -ErrorAction Stop
```



思路：

1、msfvenom生成负载

2、负载传上去

3、msf监听

4、powershell启动wmi会话

5、从 Win32_Product 类调用 Install 方法来触发负载  



