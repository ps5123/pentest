# 枚举活动目录

在这个网络中，我们将介绍几种可用于枚举 AD 的方法。这绝不是一个完整的列表，因为可用的方法通常是高度情景化的，并且取决于获得的违规行为。但是，我们将介绍以下用于枚举 AD 的技术：

Microsoft 管理控制台的 AD 管理单元。
命令提示符的网络命令。
PowerShell 的 AD-RSAT cmdlet。
猎犬



## 凭据注入

```
runas.exe /netonly /user:<domain>\<username> cmd.exe
```

列出 SYSVOL。任何 AD 帐户，无论权限多么低，都可以读取 SYSVOL 目录的内容。

SYSVOL 是存在于所有域控制器上的文件夹。它是一个共享文件夹，用于存储组策略对象 (GPO) 和信息以及任何其他与域相关的脚本。它是 Active Directory 的重要组件，因为它将这些 GPO 传送到域中的所有计算机。加入域的计算机然后可以读取这些 GPO 并应用适用的 GPO，从中央位置进行域范围的配置更改。

在列出 SYSVOL 之前，我们需要配置 DNS。有时你很幸运，内部 DNS 会通过 DHCP 或 VPN 连接自动为你配置，但并非总是如此（比如这个 TryHackMe 网络）。最好了解如何手动执行此操作。DNS 服务器最安全的选择通常是域控制器。使用域控制器的 IP，我们可以在 PowerShell 窗口中执行以下命令：



dir \\za.tryhackme.com\SYSVOL\

dir \\za.tryhackme.com\SYSVOL和dir \\<DC IP>\SYSVOL 有什么不同？

差别很大，归结为所使用的身份验证方法。当我们提供主机名时，网络身份验证将首先尝试执行 Kerberos 身份验证。由于 Kerberos 身份验证使用嵌入在票证中的主机名，如果我们改为提供 IP，我们可以强制身份验证类型为 NTLM。虽然从表面上看，这对我们来说现在并不重要，但了解这些细微差别是有好处的，因为它们可以让你在红队评估期间保持更隐蔽。在某些情况下，组织将监控 OverPass 和 Pass-The-Hash 攻击。强制 NTLM 身份验证是书中的一个好技巧，可以避免在这些情况下被检测到。



## 通过 Microsoft 管理控制台枚举

microsoft management console 微软管理控制台

我们将使用带有远程服务器管理工具(RSAT) AD管理单元的 Microsoft 管理控制台 (MMC)





## 通过命令提示符枚举

CMD 有一个内置命令，我们可以使用它来枚举有关AD 的信息，即net. 该net命令是一个方便的工具，用于枚举有关本地系统和AD 的信息。我们将看看我们可以从这个位置列举的一些有趣的事情，但这并不是一个详尽的清单。





users

我们可以使用net命令，通过使用用户子选项来列出AD域中的所有用户：

net user /domain



我们还可以使用这个子选项来列举单个用户账户的更多详细信息：

net user <username> /domain



groups

我们可以使用net命令，通过使用组的子选项来列举域的组：

net group /domain



我们还可以通过在同一命令中指定组别来列举更多细节，如组别成员：

net group <groupname> /domain



密码政策(password policy)

我们可以使用net命令，通过使用账户子选项来列举域的密码策略：

net accounts

这将为我们提供有用的信息，例如：

保留的密码历史长度。这意味着用户必须提供多少个唯一密码才能重复使用旧密码。
错误密码尝试的锁定阈值以及帐户将被锁定的时间。
密码的最小长度。
允许密码达到的最长期限指示是否必须定期轮换密码。



如果我们想对我们现在列举的其他用户帐户进行额外的密码喷射攻击，这些信息可以使我们受益。它可以帮助我们更好地猜测我们应该在攻击中使用哪些单一密码，以及在我们冒着锁定帐户的风险之前我们可以运行多少次攻击。但是，应该注意的是，如果我们执行盲密码喷洒攻击，我们可能会锁定帐户，因为我们没有检查确定特定帐户在被锁定之前还剩下多少次尝试。





好处

不需要额外的或外部的工具，而且这些简单的命令通常不会被蓝队监控。
我们不需要 GUI 来执行此枚举。
通常用于网络钓鱼有效负载的 VBScript 和其他宏语言本身就支持这些命令，因此它们可用于在制作更具体的有效负载之前枚举有关AD域的初始信息。



缺点

这些net命令必须从加入域的计算机上执行。如果计算机未加入域，它将默认为 WORKGROUP 域。
这些net命令可能不会显示所有信息。例如，如果用户是十多个组的成员，则并非所有这些组都将显示在输出中。





## 通过 PowerShell 枚举



PowerShell

PowerShell是命令提示符的升级。Microsoft 于 2006 年首次发布它。虽然 PowerShell 具有命令提示符提供的所有标准功能，但它还提供对 cmdlet（发音为 command-lets）的访问，这些 .NET 类是执行特定功能的。虽然我们可以编写自己的 cmdlet，就像PowerView的创建者所做的那样，但我们已经可以使用内置的 cmdlet 走得很远了。



### users





好处

PowerShell cmdlet 可以枚举比命令提示符中的 net 命令多得多的信息。
我们可以指定服务器和域来使用未加入域的机器上的 runas 来执行这些命令。
我们可以创建自己的 cmdlet 来枚举特定信息。
我们可以使用AD -RSAT cmdlet 直接更改 AD 对象，例如重置密码或将用户添加到特定组。



缺点

PowerShell通常比命令提示符更受蓝队监控。
我们必须安装 AD-RSAT 工具或使用其他可能可检测到的脚本来进行PowerShell枚举。



## 通过Bloodhound枚举

在启动 Bloodhound 之前，我们需要加载 Neo4j：



```
neo4j console start
```

在另一个终端选项卡中，运行bloodhound --no-sandbox. 这将向您显示身份验证 GUI：







### 只有会话数据



AD的结构在大型组织中不会经常改变。可能会有几个新员工，但 OU、组、用户和权限的整体结构将保持不变。
但是，不断变化的一件事是活动会话和登录事件。由于 Sharphound 创建了AD结构的时间点快照，活动会话数据并不总是准确的，因为一些用户可能已经注销了他们的会话，或者新用户可能已经建立了新会话。这是需要注意的重要事项，也是我们希望定期执行 Sharphound 的原因。

一个好的方法是在评估开始时使用“全部”收集方法执行 Sharphound，然后使用“会话”收集方法每天至少执行两次 Sharphound。这将为您提供新的会话数据并确保这些运行速度更快，因为它们不会再次枚举整个AD结构。执行这些会话运行的最佳时间是在 10:00 左右，当用户喝第一杯咖啡并开始工作时，以及在 14:00 左右，当他们从午休时间回来但在他们回家之前。

在从这些新的 Sharphound 运行中导入数据之前，您可以通过单击“清除会话信息”在数据库信息选项卡上清除 Bloodhound 中停滞的会话数据。





