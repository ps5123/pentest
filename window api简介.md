# window api简介

学习过程中一定要对术语有一些了解



## 介绍

Windows API 提供本机功能以与 Windows 操作系统的关键组件进行交互。该 API 被许多人广泛使用，包括红队、威胁参与者、蓝队、软件开发人员和解决方案提供商。

API 可以与 Windows 系统无缝集成，提供其范围的用例。您可能会看到 Win32 API 被用于攻击性工具和恶意软件开发、  EDR（端点检测与 响应）工程和通用软件应用程序。 有关 API 所有用例的更多信息，请查看 Windows API 索引。

学习目标
了解 Windows API 是什么、它的用例以及它如何与操作系统子系统交互
了解如何使用不同语言实现 Windows API
了解如何从恶意角度使用 Windows API 并分解几个实际案例研究
在开始这个房间之前，我们建议您大致熟悉操作系统体系结构。还建议但不要求具备基本的编程知识。

这个房间旨在从基础层面讲授 Windows API。我们将简要介绍 Win32 API 的实现，但我们将重点介绍使用 API 调用的原因和位置。

请系好安全带并找到离您最近的出口。



## 子系统和硬件交互

程序通常需要访问或修改 Windows 子系统或硬件，但仅限于维护机器稳定性。为了解决这个问题，Microsoft 发布了 Win32 API，这是一个连接用户模式应用程序和内核的库。

Windows 通过两种不同的模式区分硬件访问：用户模式和内核模式。这些模式决定了允许应用程序或驱动程序访问的硬件、内核和内存。各模式之间的API或系统调用接口，在内核模式下向系统发送信息进行处理。

用户模式	内核模式
没有直接的硬件访问
直接硬件访问
访问“拥有的”内存位置
访问整个物理内存



## Windows API 的组件

Win32 API，通常称为 Windows API，有几个依赖组件，用于定义 API 的结构和组织。



## 操作系统库



Win32 库的每个 API 调用都驻留在内存中，需要一个指向内存地址的指针。由于 ASLR ( A address  S pace  L ayout  R andomization) 实现，获取指向这些函数的指针的过程是模糊的；每种语言或包都有独特的程序来克服 ASLR。在整个会议室中，我们将讨论两种最流行的实现：  P/Invoke和 Windows 头文件。

在此任务中，我们将深入研究这两种实现的工作原理，并在未来的任务中将它们付诸实践。



Windows 头文件
Microsoft 发布了 Windows 头文件，也称为 Windows 加载程序，作为与 ASLR 实施相关的问题的直接解决方案。将概念保持在较高层次，在运行时，加载程序将确定正在进行的调用并创建一个 thunk 表以获取函数地址或指针。

幸运的是，如果我们不想这样做，我们不必深入研究就可以继续使用 API 调用。

一旦windows.h文件包含在非托管程序的顶部；可以调用任何 Win32 函数。



P/Invoke

微软将 P/Invoke 或平台调用描述为“一种允许您从托管代码访问非托管库中的结构、回调和函数的技术。”

P/invoke 提供了工具来处理从托管代码调用非托管函数的整个过程，换句话说，就是调用 Win32 API。P/invoke 将通过导入包含非托管函数或 Win32 API 调用的所需DLL来启动。







## API调用结构

API 调用是 Win32 库的第二个主要组成部分。这些调用提供可扩展性和灵活性，可用于满足大量用例。大多数 Win32 API 调用都在Windows API 文档和 pinvoke.net下有详细记录 。



## C API 实现





## .NET 和 PowerShell API 实现





## 经常被滥用的 API 调用



Win32 库中的多个 API 调用很容易被恶意活动利用。

一些实体试图记录和组织所有可用的带有恶意向量的 API 调用，包括 SAN和 MalAPI.io。



## 恶意软件案例研究



在键盘记录器示例中，使用什么 Win32 API 调用来获取我们当前进程的伪句柄？

什么 Win32 API 调用用于 在键盘记录器示例中设置我们当前进程的挂钩？

什么 Win32 API 调用用于从 键盘记录器示例中的伪句柄获取句柄？

在键盘记录器示例中，使用什么 Win32 API 调用来取消对我们当前进程的挂钩 ？