# windows内部结构

学习目标
了解 Windows 进程及其底层技术并与之交互。
了解核心文件格式及其使用方式。
与 Windows 内部交互并了解 Windows 内核的运行方式。

## 进程

如前所述，进程是从应用程序的执行中创建的。进程是 Windows 运行方式的核心，Windows 的大多数功能都可以作为应用程序包含并具有相应的进程。以下是启动进程的默认应用程序的几个示例。

MsMpEng（微软后卫）
wininit（键盘和鼠标）
lsass（凭证存储）



攻击者可以将进程作为目标来逃避检测并将恶意软件隐藏为合法进程。以下是攻击者可以针对进程使用的潜在攻击向量的一小部分列表

进程注入





## 线程

﻿线程是进程使用的可执行单元，并根据设备因素进行调度。

设备因素可能因 CPU 和内存规格、优先级和逻辑因素以及其他因素而异。

我们可以简化线程的定义：“控制进程的执行”。

由于线程控制执行，因此这是一个常见的目标组件。线程滥用可以单独用于帮助代码执行，或者作为其他技术的一部分更广泛地用于与其他 API 调用链接。 、



## 虚拟内存

## 



## 动态链接库



Microsoft文档将DLL描述为“包含可同时被多个程序使用的代码和数据的库”。

DLL 被用作 Windows 中应用程序执行背后的核心功能之一。来自Windows 文档，“DLL 的使用有助于促进代码模块化、代码重用、高效内存使用和减少磁盘空间。因此，操作系统和程序加载速度更快，运行速度更快，并且占用计算机上的磁盘空间更少”

当DLL作为程序中的函数加载时，DLL 被指定为依赖项。由于程序依赖于 DLL，因此攻击者可以将 DLL 而不是应用程序作为目标来控制执行或功能的某些方面。

DLL劫持 ( T1574.001 )
DLL侧载 ( T1574.002 )
DLL注入 ( T1055.001 )



## 便携式可执行格式

可执行文件和应用程序是 Windows 内部如何在更高级别运行的很大一部分。PE ( Portable Executable ) 格式定义了有关可执行文件和存储数据的信息。PE 格式还定义了数据组件的存储结构。

PE（可移植可执行文件）格式是可执行文件和目标文件的总体结构。PE ( Portable Executable ) 和 COFF ( Common O bject File F ormat )文件组成了 PE 格式。



## 与windows内部交互

与 Windows 内部交互可能看起来令人生畏，但它已被大大简化。与 Windows Internals 交互的最容易访问和研究的选项是通过 Windows API 调用进行交互。Windows API 提供与 Windows 操作系统交互的本机功能。API 包含 Win32 API 和不太常见的 Win64 API。

在本会议室中，我们将仅简要概述使用与 Windows 内部相关的一些特定 API 调用。查看Windows API 室，了解有关 Windows API 的更多信息。

大多数 Windows 内部组件需要与物理硬件和内存进行交互。

Windows 内核将控制所有程序和进程，并桥接所有软件和硬件交互。这一点尤其重要，因为许多 Windows 内部构件需要以某种形式与内存进行交互。

默认情况下，应用程序通常无法与内核交互或修改物理硬件，因此需要一个接口。这个问题通过使用处理器模式和访问级别来解决。

Windows 处理器有 用户模式 和 内核 模式。处理器将根据访问和请求的模式在这些模式之间切换。

用户模式和内核模式之间的切换通常由系统和 API 调用来促进。在文档中，此点有时称为“切换点”。